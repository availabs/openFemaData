with calcs as (
SELECT geoid, swd_raw_total, our_total, nri_total, percent_diff_total
	FROM public.tmp_full_data_table
	where percent_diff_total is not null
	order by percent_diff_total desc
)

select substring(details.geoid, 1, 5) geoid, state_fips::text || lpad(cz_fips::text, 3, '0') cz_fips,
swd_raw_total, property_damage event_damage, our_total, nri_total,
percent_diff_total, stcofips,
cfld_hlrb * cfld_afreq * cfld_expb nri_cz_fips_total,
((our_total - (cfld_hlrb * cfld_afreq * cfld_expb)) / (cfld_hlrb * cfld_afreq * cfld_expb)) * 100 percent_diff_our_total_nri_cz_fips_total
,((nri_total - (cfld_hlrb * cfld_afreq * cfld_expb)) / (cfld_hlrb * cfld_afreq * cfld_expb)) * 100 percent_diff_nri_total_nri_cz_fips_total

from severe_weather_new.details
JOIN calcs
ON substring(details.geoid, 1, 5) = calcs.geoid
and details.event_type_formatted = 'coastal'
JOIN national_risk_index.nri_counties_november_2021 nri
ON nri.stcofips = state_fips::text || lpad(cz_fips::text, 3, '0')
and cfld_expb > 0
where cz_type = 'Z'
-- and substring(details.geoid, 1, 5) = ''
order by geoid, cz_fips desc




